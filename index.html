<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medication Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .color-swatch {
            transition: transform 0.2s ease-in-out;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
        .color-swatch.selected {
            outline: 2px solid white;
            outline-offset: 2px;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center text-center p-4">
        <h1 class="text-4xl md:text-5xl font-bold text-cyan-400 mb-4">Medication Tracker</h1>
        <p class="text-lg text-gray-300 mb-8 max-w-md">Please sign in with your Google account to securely track and save your medication logs.</p>
        <button id="sign-in-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 flex items-center gap-3">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C44.599 36.372 48 30.817 48 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
            Sign In with Google
        </button>
    </div>

    <!-- Main App Content -->
    <div id="app-content" class="container mx-auto p-4 md:p-8 hidden">
        <div class="flex justify-between items-center mb-8">
            <div>
                <p class="text-gray-400 text-sm">Signed in as:</p>
                <p id="user-name" class="font-semibold"></p>
            </div>
            <button id="sign-out-btn" class="bg-gray-700 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Sign Out</button>
        </div>
        
        <!-- Clock Display -->
        <div class="text-center mb-8">
            <h1 class="text-2xl md:text-4xl font-bold text-cyan-400">Medication Tracker</h1>
            <p class="text-lg md:text-2xl text-gray-300 mt-2" id="clock"></p>
        </div>

        <!-- Main Content Grid -->
        <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Dynamic cards go here -->
        </div>

        <!-- Add New Card Button -->
        <div class="mt-8 text-center">
            <button id="add-card-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                + Add New Card
            </button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50 transition-opacity duration-300">
        <div class="bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-700 w-full max-w-sm text-center transform transition-all duration-300 scale-95">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-4">Are you sure?</h3>
            <p id="modal-text" class="text-gray-300 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Cancel</button>
                <button id="modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, query, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE & CONFIG ---
        let state = {
            children: [],
            modal: { isOpen: false, type: null, targetId: null, message: '' },
            listeners: {}, // To store unsubscribe functions for Firestore listeners
            editingLogId: null
        };

        const availableColors = {
            pink: { text: 'text-pink-400', bg: 'bg-pink-600', hoverBg: 'hover:bg-pink-700', ring: 'focus:ring-pink-500', border: 'border-pink-500' },
            blue: { text: 'text-blue-400', bg: 'bg-blue-600', hoverBg: 'hover:bg-blue-700', ring: 'focus:ring-blue-500', border: 'border-blue-500' },
            yellow: { text: 'text-yellow-400', bg: 'bg-yellow-600', hoverBg: 'hover:bg-yellow-700', ring: 'focus:ring-yellow-500', border: 'border-yellow-500' },
            green: { text: 'text-green-400', bg: 'bg-green-600', hoverBg: 'hover:bg-green-700', ring: 'focus:ring-green-500', border: 'border-green-500' },
            purple: { text: 'text-purple-400', bg: 'bg-purple-600', hoverBg: 'hover:bg-purple-700', ring: 'focus:ring-purple-500', border: 'border-purple-500' },
            indigo: { text: 'text-indigo-400', bg: 'bg-indigo-600', hoverBg: 'hover:bg-indigo-700', ring: 'focus:ring-indigo-500', border: 'border-indigo-500' },
        };

        // --- FIREBASE SETUP ---
        const firebaseConfig = {
          apiKey: "AIzaSyCNxXQS_91J5hGepv0YAtq3HUj9vxHgvsw",
          authDomain: "meds-de0b7.firebaseapp.com",
          projectId: "meds-de0b7",
          storageBucket: "meds-de0b7.firebasestorage.app",
          messagingSenderId: "602148649143",
          appId: "1:602148649143:web:8f582cbec9ea92f505b532"
        };
        
        let app, db, auth, userId;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            document.body.innerHTML = '<h1>Error initializing application. Please check console.</h1>';
        }

        // --- UI ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const appContent = document.getElementById('app-content');
        const signInBtn = document.getElementById('sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userNameDisplay = document.getElementById('user-name');
        const cardsContainer = document.getElementById('cards-container');
        const addCardBtn = document.getElementById('add-card-btn');
        const modalEl = document.getElementById('confirmation-modal');
        const modalContent = modalEl.querySelector('div');
        const modalText = document.getElementById('modal-text');
        const modalCancelBtn = document.getElementById('modal-cancel');
        const modalConfirmBtn = document.getElementById('modal-confirm');

        // --- CLOCK ---
        const clockElement = document.getElementById('clock');
        const pageLoadTime = new Date();
        const clockOptions = { timeZone: 'America/New_York', hour: 'numeric', minute: '2-digit', hour12: true };
        clockElement.textContent = `Last refreshed: ${pageLoadTime.toLocaleTimeString('en-US', clockOptions)}`;

        // --- AUTHENTICATION ---
        const provider = new GoogleAuthProvider();
        signInBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(err => {
                console.error("Sign-in error:", err);
                alert(`Could not sign in with Google.\n\nThis may be due to a configuration issue. Please ensure this website's domain (${window.location.hostname}) is added to the list of authorized domains in your Firebase project's authentication settings.\n\nError: ${err.message}`);
            });
        });
        signOutBtn.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in
                userId = user.uid;
                userNameDisplay.textContent = user.displayName || user.email;
                appContent.classList.remove('hidden');
                loginScreen.classList.add('hidden');
                initializeAppForUser();
            } else {
                // User is signed out
                userId = null;
                appContent.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                cleanupListenersAndUI();
            }
        });

        // --- APP INITIALIZATION & CLEANUP ---
        function initializeAppForUser() {
            const childrenRef = collection(db, 'users', userId, 'children');
            state.listeners['children'] = onSnapshot(query(childrenRef), snapshot => {
                state.children = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
        }

        function cleanupListenersAndUI() {
            Object.values(state.listeners).forEach(unsubscribe => unsubscribe());
            state.listeners = {};
            state.children = [];
            cardsContainer.innerHTML = '';
        }

        // --- DYNAMIC CARD CREATION ---
        function createCardHTML(child) {
            const colorTheme = availableColors[child.color];
            const isEditing = child.isEditing;
            const colorSwatchesHTML = Object.keys(availableColors).map(colorKey => `
                <div class="color-swatch w-8 h-8 rounded-full cursor-pointer ${availableColors[colorKey].bg.replace('bg-','border-2 border-')} ${child.color === colorKey ? 'selected' : ''}" data-color="${colorKey}" style="background-color: #${{'pink':'ec4899','blue':'3b82f6','yellow':'eab308','green':'22c55e','purple':'a855f7','indigo':'6366f1'}[colorKey]}"></div>`).join('');

            return `<div class="bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-700 flex flex-col" id="${child.id}">
                <div class="relative">
                    <div class="absolute top-0 right-0 flex gap-2">
                        <button data-action="edit" class="text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>
                        <button data-action="delete" class="text-gray-400 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                    </div>
                    ${isEditing ? `<input type="text" value="${child.name}" class="text-3xl font-bold text-center w-full bg-gray-700 rounded-md p-1 mb-2 ${colorTheme.text}"><div class="flex justify-center gap-3 my-4">${colorSwatchesHTML}</div><button data-action="save" class="w-full ${colorTheme.bg} ${colorTheme.hoverBg} text-white font-bold py-2 px-4 rounded-lg">Save Changes</button>` : `<h2 class="text-3xl font-bold text-center mb-6 ${colorTheme.text}">${child.name}</h2>`}
                </div>
                ${!isEditing ? `<form class="space-y-4"><input type="hidden" name="childId" value="${child.id}"><div><label class="block text-sm font-medium text-gray-300">What?</label><input type="text" name="what" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none ${colorTheme.ring} ${colorTheme.border}" placeholder="ex: Tylenol" list="what-suggestions-${child.id}"><datalist id="what-suggestions-${child.id}"></datalist></div><div><label class="block text-sm font-medium text-gray-300">Quantity</label><input type="text" name="howMuch" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none ${colorTheme.ring} ${colorTheme.border}" placeholder="ex: 5 ml" list="howMuch-suggestions-${child.id}"><datalist id="howMuch-suggestions-${child.id}"></datalist></div><div><label class="block text-sm font-medium text-gray-300">When?</label><div class="flex items-center gap-2 mt-1"><input type="time" name="when" required class="block w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:outline-none ${colorTheme.ring} ${colorTheme.border}"><button type="button" data-action="setNow" class="bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-2 px-4 rounded-md text-sm whitespace-nowrap">Now</button></div></div><button type="submit" class="w-full ${colorTheme.bg} ${colorTheme.hoverBg} text-white font-bold py-2 px-4 rounded-lg transform hover:scale-105">Log Medication</button></form><div class="mt-8 flex-grow flex flex-col"><div class="flex justify-between items-center"><h3 class="text-xl font-semibold text-gray-200">Log History</h3><button data-action="clearLog" class="text-sm bg-gray-700 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md">Clear Log</button></div><ul class="log-list mt-4 space-y-3 max-h-60 overflow-y-auto pr-2 flex-grow"></ul></div>` : ''}
            </div>`;
        }

        function timeAgo(timestamp) {
            if (!timestamp || !timestamp.toDate) {
                return '';
            }
            const now = new Date();
            const past = timestamp.toDate();
            const seconds = Math.floor((now - past) / 1000);

            let interval = seconds / 2592000; // month
            if (interval > 1) {
                const value = Math.floor(interval);
                return `${value} month${value > 1 ? 's' : ''} ago`;
            }
            interval = seconds / 86400; // day
            if (interval > 1) {
                const value = Math.floor(interval);
                if (value === 1) return "Yesterday";
                return `${value} days ago`;
            }
            interval = seconds / 3600; // hour
            if (interval > 1) {
                const hours = Math.floor(interval);
                const minutes = Math.floor((seconds % 3600) / 60);
                let result = `${hours}h`;
                if (minutes > 0) {
                    result += `${minutes.toString().padStart(2, '0')}`;
                }
                result += ' ago';
                return result;
            }
            interval = seconds / 60; // minute
            if (interval > 1) {
                const value = Math.floor(interval);
                return `${value} minute${value > 1 ? 's' : ''} ago`;
            }
            if (seconds < 10) return "Just now";
            return `${Math.floor(seconds)} seconds ago`;
        }

        // --- RENDER & EVENT HANDLING ---
        function render() {
            cardsContainer.innerHTML = '';
            state.children.forEach(child => {
                cardsContainer.insertAdjacentHTML('beforeend', createCardHTML(child));
                const cardElement = document.getElementById(child.id);
                if (!child.isEditing) {
                    // Subscribe to log updates for this card
                    if (state.listeners[child.id]) state.listeners[child.id](); // Unsubscribe from old listener first
                    const logsRef = collection(db, 'users', userId, 'logs', child.id, 'entries');
                    state.listeners[child.id] = onSnapshot(query(logsRef, orderBy('timestamp', 'desc')), snapshot => {
                        const childIndex = state.children.findIndex(c => c.id === child.id);
                        if (childIndex > -1) {
                            const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            state.children[childIndex].logs = logs;
                            renderLogs(child.id, logs);
                            updateAutocompleteSuggestions(child.id, logs);
                        }
                    });
                }
                cardElement.addEventListener('click', handleCardAction);
                cardElement.querySelector('form')?.addEventListener('submit', handleFormSubmit);
            });
        }
        
        async function handleCardAction(e) {
            const actionTarget = e.target.closest('button, .color-swatch');
            if (!actionTarget) return;

            const action = actionTarget.dataset.action;
            const childId = e.currentTarget.id;
            const child = state.children.find(c => c.id === childId);

            // Handle log-specific actions
            if (action === 'editLog' || action === 'deleteLog' || action === 'saveLog' || action === 'cancelEditLog') {
                const logLi = actionTarget.closest('li[data-log-id]');
                const logId = logLi.dataset.logId;
                const childToUpdate = state.children.find(c => c.id === childId);

                switch (action) {
                    case 'deleteLog':
                        const logToDelete = childToUpdate.logs.find(l => l.id === logId);
                        if (logToDelete) {
                            const message = `Are you sure you want to delete the entry for <strong>${logToDelete.what}</strong> (${logToDelete.howMuch})?`;
                            showModal('deleteLog', { childId, logId }, message, 'Delete');
                        } else {
                            // Fallback for safety, though this case should not be reached in normal operation
                            showModal('deleteLog', { childId, logId }, `Are you sure you want to delete this log entry?`, 'Delete');
                        }
                        break;
                    case 'editLog':
                        state.editingLogId = logId;
                        renderLogs(childId, childToUpdate.logs);
                        break;
                    case 'cancelEditLog':
                        state.editingLogId = null;
                        renderLogs(childId, childToUpdate.logs);
                        break;
                    case 'saveLog':
                        const what = logLi.querySelector('[name="editWhat"]').value.trim();
                        const howMuch = logLi.querySelector('[name="editHowMuch"]').value.trim();
                        const when = logLi.querySelector('[name="editWhen"]').value;
                        const logRef = doc(db, 'users', userId, 'logs', childId, 'entries', logId);
                        await updateDoc(logRef, { what, howMuch, when });
                        state.editingLogId = null;

                        // Manually update the log in the local state to avoid flicker
                        const logIndex = childToUpdate.logs.findIndex(l => l.id === logId);
                        if (logIndex > -1) {
                            childToUpdate.logs[logIndex] = { ...childToUpdate.logs[logIndex], what, howMuch, when };
                        }

                        renderLogs(childId, childToUpdate.logs);
                        break;
                }
                return; // Stop further processing for log actions
            }

            // Handle card actions
            if (!action) {
                const color = actionTarget.dataset.color;
                if(color && child.isEditing) {
                     document.querySelectorAll(`#${childId} .color-swatch`).forEach(el => el.classList.remove('selected'));
                     actionTarget.classList.add('selected');
                     const childRef = doc(db, 'users', userId, 'children', childId);
                     await updateDoc(childRef, { color: color });
                }
                return;
            }
            
            switch(action) {
                case 'edit':
                    await updateDoc(doc(db, 'users', userId, 'children', childId), { isEditing: true });
                    break;
                case 'delete':
                    showModal('deleteCard', childId, `This will permanently delete the card for <strong class="${availableColors[child.color].text}">${child.name}</strong> and all its logs. This cannot be undone.`);
                    break;
                case 'save':
                    const nameInput = document.querySelector(`#${childId} input[type="text"]`);
                    const newName = nameInput.value.trim() || child.name;
                    await updateDoc(doc(db, 'users', userId, 'children', childId), { name: newName, isEditing: false });
                    break;
                case 'clearLog':
                    showModal('clearLog', childId, `This will permanently delete all log entries for <strong class="${availableColors[child.color].text}">${child.name}</strong>.`);
                    break;
                case 'setNow':
                    const whenInput = document.querySelector(`#${childId} input[name="when"]`);
                    const now = new Date();
                    whenInput.value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                    break;
            }
        }
        
        async function handleFormSubmit(e) {
            e.preventDefault();
            const form = e.currentTarget;
            const formData = new FormData(form);
            const childId = formData.get('childId');
            const now = new Date();
            const newLog = {
                what: formData.get('what').trim(),
                howMuch: formData.get('howMuch').trim(),
                when: formData.get('when'),
                date: now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                timestamp: now
            };
            const logsRef = collection(db, 'users', userId, 'logs', childId, 'entries');
            await addDoc(logsRef, newLog);

            form.querySelector('[name="what"]').value = '';
            form.querySelector('[name="howMuch"]').value = '';
            form.querySelector('[name="when"]').value = '';
        }

        function renderLogs(childId, logs) {
            const logUl = document.querySelector(`#${childId} .log-list`);
            if (!logUl) return;
            logUl.innerHTML = '';
            const child = state.children.find(c => c.id === childId);
            const childColor = child?.color || 'pink';

            logs.forEach(log => {
                let logHTML;
                if (state.editingLogId === log.id) {
                    // Editing UI
                    logHTML = `
                        <li class="bg-gray-700 p-3 rounded-lg border-l-4 ${availableColors[childColor].border}" data-log-id="${log.id}">
                            <div class="space-y-2">
                                <input type="text" name="editWhat" value="${log.what}" class="block w-full bg-gray-600 border border-gray-500 rounded-md py-1 px-2 text-white" placeholder="Medication">
                                <input type="text" name="editHowMuch" value="${log.howMuch}" class="block w-full bg-gray-600 border border-gray-500 rounded-md py-1 px-2 text-white" placeholder="Quantity">
                                <input type="time" name="editWhen" value="${log.when}" class="block w-full bg-gray-600 border border-gray-500 rounded-md py-1 px-2 text-white">
                                <div class="flex justify-end gap-2 pt-1">
                                    <button data-action="cancelEditLog" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-1 px-3 rounded-md text-sm">Cancel</button>
                                    <button data-action="saveLog" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-md text-sm">Save</button>
                                </div>
                            </div>
                        </li>
                    `;
                } else {
                    // Display UI
                    const displayDate = log.timestamp.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    logHTML = `
                        <li class="bg-gray-700 p-3 rounded-lg border-l-4 ${availableColors[childColor].border}" data-log-id="${log.id}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-lg">${log.what} - ${log.howMuch}</p>
                                    <p class="text-sm text-gray-400">${displayDate} at ${log.when} <span class="text-gray-500 ml-2">(${timeAgo(log.timestamp)})</span></p>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <button data-action="editLog" class="text-gray-400 hover:text-white p-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>
                                    <button data-action="deleteLog" class="text-gray-400 hover:text-red-500 p-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                                </div>
                            </div>
                        </li>
                    `;
                }
                logUl.innerHTML += logHTML;
            });
        }

        function updateAutocompleteSuggestions(childId, logs) {
            const whatDatalist = document.getElementById(`what-suggestions-${childId}`);
            const howMuchDatalist = document.getElementById(`howMuch-suggestions-${childId}`);

            if (!whatDatalist || !howMuchDatalist) return;

            const whatSuggestions = new Set(logs.map(log => log.what ? log.what.trim() : log.what));
            const howMuchSuggestions = new Set(logs.map(log => log.howMuch ? log.howMuch.trim() : log.howMuch));

            whatDatalist.innerHTML = [...whatSuggestions].map(suggestion => `<option value="${suggestion}"></option>`).join('');
            howMuchDatalist.innerHTML = [...howMuchSuggestions].map(suggestion => `<option value="${suggestion}"></option>`).join('');
        }

        // --- GLOBAL ACTIONS ---
        addCardBtn.addEventListener('click', async () => {
            const newName = prompt("Enter the new card's name:", "New Child");
            if (newName && newName.trim()) {
                const colorKeys = Object.keys(availableColors);
                const randomColor = colorKeys[Math.floor(Math.random() * colorKeys.length)];
                await addDoc(collection(db, 'users', userId, 'children'), {
                    name: newName.trim(),
                    color: randomColor,
                    isEditing: false
                });
            }
        });

        // --- MODAL LOGIC ---
        function showModal(type, targetId, message, confirmText = 'Confirm') {
            state.modal = { isOpen: true, type, targetId, message };
            modalText.innerHTML = state.modal.message;
            modalConfirmBtn.textContent = confirmText;
            modalEl.classList.remove('hidden');
            setTimeout(() => { modalEl.style.opacity = '1'; modalContent.style.transform = 'scale(1)'; }, 10);
        }

        function hideModal() {
            modalEl.style.opacity = '0';
            modalContent.style.transform = 'scale(0.95)';
            setTimeout(() => {
                modalEl.classList.add('hidden');
                state.modal = { isOpen: false, type: null, targetId: null, message: '' };
                modalConfirmBtn.textContent = 'Confirm'; // Reset button text
            }, 300);
        }

        async function confirmModalAction() {
            const { type, targetId } = state.modal;

            if (type === 'deleteLog') {
                const { childId, logId } = targetId;
                const logRef = doc(db, 'users', userId, 'logs', childId, 'entries', logId);
                await deleteDoc(logRef);
            } else {
                const batch = writeBatch(db);
                if (type === 'clearLog' || type === 'deleteCard') {
                    const logsRef = collection(db, 'users', userId, 'logs', targetId, 'entries');
                    const logsSnapshot = await getDocs(logsRef);
                    logsSnapshot.forEach(doc => batch.delete(doc.ref));
                }
                if (type === 'deleteCard') {
                    const childRef = doc(db, 'users', userId, 'children', targetId);
                    batch.delete(childRef);
                }
                await batch.commit();
            }

            hideModal();
        }
        
        modalCancelBtn.addEventListener('click', hideModal);
        modalConfirmBtn.addEventListener('click', confirmModalAction);
    </script>
</body>
</html>

