<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medication Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center text-center p-4">
        <h1 class="text-4xl md:text-5xl font-bold text-cyan-400 mb-4">Medication Tracker</h1>
        <p class="text-lg text-gray-300 mb-8 max-w-md">Please sign in with your Google account to securely track and save your medication logs.</p>
        <button id="sign-in-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 flex items-center gap-3">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.222 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C44.599 36.372 48 30.817 48 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
            Sign In with Google
        </button>
    </div>

    <!-- Main App Content -->
    <div id="app-content" class="container mx-auto p-4 md:p-8 hidden">
        
        <!-- Header with User Info and Sign Out -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <p class="text-gray-400 text-sm">Signed in as:</p>
                <p id="user-name" class="font-semibold"></p>
            </div>
            <button id="sign-out-btn" class="bg-gray-700 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Sign Out</button>
        </div>

        <!-- Clock Display -->
        <div class="text-center mb-8">
            <h1 class="text-2xl md:text-4xl font-bold text-cyan-400">Medication Tracker</h1>
            <p class="text-lg md:text-2xl text-gray-300 mt-2" id="clock"></p>
            <p class="text-sm text-gray-500">Current Time (EST/EDT)</p>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <!-- Hinata's Card -->
            <div id="hinata-card" class="bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-700">
                <h2 class="text-3xl font-bold text-center mb-6 text-pink-400">Hinata</h2>
                <form id="hinata-form" class="space-y-4">
                    <div>
                        <label for="hinata-what" class="block text-sm font-medium text-gray-300">What</label>
                        <input type="text" id="hinata-what" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder="e.g., Tylenol">
                    </div>
                    <div>
                        <label for="hinata-how-much" class="block text-sm font-medium text-gray-300">How Much (ml)</label>
                        <input type="number" id="hinata-how-much" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500" placeholder="e.g., 5">
                    </div>
                    <div>
                        <label for="hinata-when" class="block text-sm font-medium text-gray-300">When</label>
                        <input type="time" id="hinata-when" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-pink-500 focus:border-pink-500">
                    </div>
                    <button type="submit" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">Log Medication</button>
                </form>
                <div class="mt-8">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-gray-200">Log History</h3>
                        <button id="clear-hinata" class="text-sm bg-gray-700 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition duration-300">Clear Log</button>
                    </div>
                    <ul id="hinata-log" class="mt-4 space-y-3 max-h-60 overflow-y-auto pr-2"></ul>
                </div>
            </div>

            <!-- Neiji's Card -->
            <div id="neiji-card" class="bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-700">
                <h2 class="text-3xl font-bold text-center mb-6 text-blue-400">Neiji</h2>
                <form id="neiji-form" class="space-y-4">
                    <div>
                        <label for="neiji-what" class="block text-sm font-medium text-gray-300">What</label>
                        <input type="text" id="neiji-what" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Advil">
                    </div>
                    <div>
                        <label for="neiji-how-much" class="block text-sm font-medium text-gray-300">How Much (ml)</label>
                        <input type="number" id="neiji-how-much" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 5">
                    </div>
                    <div>
                        <label for="neiji-when" class="block text-sm font-medium text-gray-300">When</label>
                        <input type="time" id="neiji-when" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">Log Medication</button>
                </form>
                <div class="mt-8">
                     <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-gray-200">Log History</h3>
                        <button id="clear-neiji" class="text-sm bg-gray-700 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition duration-300">Clear Log</button>
                    </div>
                    <ul id="neiji-log" class="mt-4 space-y-3 max-h-60 overflow-y-auto pr-2"></ul>
                </div>
            </div>

            <!-- Ariasy's Card -->
            <div id="ariasy-card" class="bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-700">
                <h2 class="text-3xl font-bold text-center mb-6 text-yellow-400">Ariasy</h2>
                <form id="ariasy-form" class="space-y-4">
                    <div>
                        <label for="ariasy-what" class="block text-sm font-medium text-gray-300">What</label>
                        <input type="text" id="ariasy-what" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-yellow-500 focus:border-yellow-500" placeholder="e.g., Tylenol">
                    </div>
                    <div>
                        <label for="ariasy-how-much" class="block text-sm font-medium text-gray-300">How Much (ml)</label>
                        <input type="number" id="ariasy-how-much" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-yellow-500 focus:border-yellow-500" placeholder="e.g., 5">
                    </div>
                    <div>
                        <label for="ariasy-when" class="block text-sm font-medium text-gray-300">When</label>
                        <input type="time" id="ariasy-when" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">Log Medication</button>
                </form>
                <div class="mt-8">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-gray-200">Log History</h3>
                        <button id="clear-ariasy" class="text-sm bg-gray-700 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition duration-300">Clear Log</button>
                    </div>
                    <ul id="ariasy-log" class="mt-4 space-y-3 max-h-60 overflow-y-auto pr-2"></ul>
                </div>
            </div>

            <!-- Elvin's Card -->
            <div id="elvin-card" class="bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-700">
                <h2 class="text-3xl font-bold text-center mb-6 text-green-400">Elvin</h2>
                <form id="elvin-form" class="space-y-4">
                    <div>
                        <label for="elvin-what" class="block text-sm font-medium text-gray-300">What</label>
                        <input type="text" id="elvin-what" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="e.g., Advil">
                    </div>
                    <div>
                        <label for="elvin-how-much" class="block text-sm font-medium text-gray-300">How Much (ml)</label>
                        <input type="number" id="elvin-how-much" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="e.g., 5">
                    </div>
                    <div>
                        <label for="elvin-when" class="block text-sm font-medium text-gray-300">When</label>
                        <input type="time" id="elvin-when" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">Log Medication</button>
                </form>
                <div class="mt-8">
                     <div class="flex justify-between items-center">
                        <h3 class="text-xl font-semibold text-gray-200">Log History</h3>
                        <button id="clear-elvin" class="text-sm bg-gray-700 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded-md transition duration-300">Clear Log</button>
                    </div>
                    <ul id="elvin-log" class="mt-4 space-y-3 max-h-60 overflow-y-auto pr-2"></ul>
                </div>
            </div>

        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50 transition-opacity duration-300">
        <div class="bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-700 w-full max-w-sm text-center transform transition-all duration-300 scale-95">
            <h3 class="text-xl font-bold text-white mb-4">Are you sure?</h3>
            <p class="text-gray-300 mb-6">This will permanently delete all log entries for <span id="modal-child-name" class="font-bold"></span>. This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Cancel</button>
                <button id="modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, getDocs, deleteDoc, doc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Configuration ---
        const children = ['hinata', 'neiji', 'ariasy', 'elvin'];
        const childColors = { hinata: 'pink', neiji: 'blue', ariasy: 'yellow', elvin: 'green' };

        // --- Firebase Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        let app, db, auth, userId;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Error initializing Firebase:", e);
        }

        // --- UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const appContent = document.getElementById('app-content');
        const signInBtn = document.getElementById('sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userNameDisplay = document.getElementById('user-name');
        
        const modal = document.getElementById('confirmation-modal');
        const modalContent = modal.querySelector('div');
        const modalChildNameSpan = document.getElementById('modal-child-name');
        const modalCancelBtn = document.getElementById('modal-cancel');
        const modalConfirmBtn = document.getElementById('modal-confirm');
        let childToClear = null;
        let unsubscribeListeners = []; // To hold our Firestore listeners

        // --- Clock Functionality ---
        const clockElement = document.getElementById('clock');
        function updateClock() {
            const now = new Date();
            const options = { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            clockElement.textContent = now.toLocaleTimeString('en-US', options);
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- Authentication Logic ---
        const provider = new GoogleAuthProvider();

        signInBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => {
                console.error("Authentication failed:", error);
            });
        });

        signOutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // --- Core Application Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                userId = user.uid;
                userNameDisplay.textContent = user.displayName || user.email;
                loginScreen.classList.add('hidden');
                appContent.classList.remove('hidden');
                
                // Set up listeners for each child's data
                children.forEach(childName => {
                    setupRealtimeListener(childName);
                    const form = document.getElementById(`${childName}-form`);
                    // Ensure we don't add multiple listeners
                    form.replaceWith(form.cloneNode(true));
                    document.getElementById(`${childName}-form`).addEventListener('submit', (e) => handleFormSubmit(e, childName));
                });
            } else {
                // User is signed out
                userId = null;
                loginScreen.classList.remove('hidden');
                appContent.classList.add('hidden');
                
                // Detach all Firestore listeners to prevent errors
                unsubscribeListeners.forEach(unsubscribe => unsubscribe());
                unsubscribeListeners = [];
                // Clear UI
                children.forEach(childName => renderLogs(childName, []));
            }
        });

        function setupRealtimeListener(childName) {
            const logsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/${childName}-med-logs`);
            const q = query(logsCollectionRef, orderBy("timestamp", "desc"));

            const unsubscribe = onSnapshot(q, (snapshot) => {
                const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLogs(childName, logs);
            }, (error) => {
                console.error(`Error fetching logs for ${childName}:`, error);
            });
            unsubscribeListeners.push(unsubscribe); // Store the unsubscribe function
        }

        function renderLogs(childName, logs) {
            const logUl = document.getElementById(`${childName}-log`);
            logUl.innerHTML = '';
            logs.forEach(log => {
                const li = document.createElement('li');
                li.className = 'bg-gray-700 p-3 rounded-lg border-l-4';
                const color = childColors[childName];
                const borderClasses = { pink: 'border-pink-500', blue: 'border-blue-500', yellow: 'border-yellow-500', green: 'border-green-500' };
                li.classList.add(borderClasses[color]);
                li.innerHTML = `
                    <div>
                        <p class="font-bold text-lg">${log.what} - ${log.howMuch}ml</p>
                        <p class="text-sm text-gray-400">Given at: ${log.when}</p>
                    </div>`;
                logUl.appendChild(li);
            });
        }

        async function handleFormSubmit(event, childName) {
            event.preventDefault();
            if (!userId) return;

            const what = document.getElementById(`${childName}-what`).value;
            const howMuch = document.getElementById(`${childName}-how-much`).value;
            const when = document.getElementById(`${childName}-when`).value;

            if (!what || !howMuch || !when) return;
            
            const [hours, minutes] = when.split(':');
            const date = new Date();
            date.setHours(hours);
            date.setMinutes(minutes);

            const newLog = { what, howMuch, when, timestamp: date };

            try {
                const logsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/${childName}-med-logs`);
                await addDoc(logsCollectionRef, newLog);
                event.target.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        }
        
        // --- Modal Confirmation Logic ---
        function showClearConfirmation(childName) {
            childToClear = childName;
            const capitalizedName = childName.charAt(0).toUpperCase() + childName.slice(1);
            modalChildNameSpan.textContent = capitalizedName;
            const color = childColors[childName];
            const textClasses = { pink: 'text-pink-400', blue: 'text-blue-400', yellow: 'text-yellow-400', green: 'text-green-400' };
            modalChildNameSpan.className = `font-bold ${textClasses[color]}`;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.style.opacity = '1';
                modalContent.style.transform = 'scale(1)';
            }, 10);
        }

        function hideClearConfirmation() {
            modal.style.opacity = '0';
            modalContent.style.transform = 'scale(0.95)';
            setTimeout(() => {
                modal.classList.add('hidden');
                childToClear = null;
            }, 300);
        }

        async function confirmClear() {
            if (childToClear && userId) {
                const logsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/${childToClear}-med-logs`);
                try {
                    const querySnapshot = await getDocs(logsCollectionref);
                    const deletePromises = querySnapshot.docs.map(docSnapshot => deleteDoc(doc(db, logsCollectionRef.path, docSnapshot.id)));
                    await Promise.all(deletePromises);
                } catch (error) {
                    console.error(`Error deleting logs for ${childToClear}: `, error);
                }
            }
            hideClearConfirmation();
        }

        // --- Final Event Listener Setup ---
        modalCancelBtn.addEventListener('click', hideClearConfirmation);
        modalConfirmBtn.addEventListener('click', confirmClear);
        children.forEach(child => {
            document.getElementById(`clear-${child}`).addEventListener('click', () => showClearConfirmation(child));
        });
    </script>
</body>
</html>

